<!DOCTYPE html>
<html>

<head>
    <title>Route Planner - Avoid Traffic</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_0W5bZ8R4rsWwrFLlIxykVaWOrU6N4rQ&callback=initMap"
        defer></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }

        body {
            font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="locationData" data-locations='{{ locations | tojson | safe }}'></div>
    <div class="container mt-5">
        <h1 class="text-center">Route Planner - Avoid Traffic</h1>
        <form id="routeForm" class="row g-3 mt-4">
            <div class="col-md-6">
                <label for="start" class="form-label">Start Location:</label>
                <select id="start" name="start" class="form-select" required>
                    {% for key, loc in locations.items() %}
                    <option value="{{ key }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="end" class="form-label">End Location:</label>
                <select id="end" name="end" class="form-select" required>
                    {% for key, loc in locations.items() %}
                    <option value="{{ key }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="avoidTraffic" class="form-label">Avoid Traffic:</label>
                <input type="checkbox" id="avoidTraffic" class="form-check-input">
            </div>
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary" onclick="calculateRoute()">Find Route</button>
            </div>
        </form>
        <div id="map" class="mt-4"></div>
    </div>

    <!-- <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Live Traffic Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <video id="trafficVideo" controls autoplay muted style="width: 100%; height: auto;">
                        <source id="videoSource" src="{{url_for('video_feed')}}" >
                        Your browser does not support the video tag.
                    </video>
                    <img src="{{url_for('video_feed')}}" alt="..." id="trafficVideo">
                </div>
            </div>
        </div>
    </div> -->

    <!-- ini dari kamera -->

    <!-- <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Live Traffic Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="trafficVideo" src="/video_feed" alt="Traffic Video" style="width: 100%; height: auto;" />
                </div>
            </div>
        </div>
    </div> -->

    <!-- ini dari streaming blob -->

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Live Traffic Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- <video id="trafficVideo" controls autoplay muted style="width: 100%; height: auto;"> -->
                        <img id="trafficImage" src="" style="width: 100%; height: auto;" />
                    </video>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        let map, directionsService, directionsRenderer, trafficLayer, waypointsMarkers = [];

        const locationData = { locations, toJson };

        // Initialize the map
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -7.915016, lng: 113.827289 }, // Default location
                zoom: 14,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
            });
        }

        // Clear existing markers
        function clearWaypointsMarkers() {
            waypointsMarkers.forEach(marker => marker.setMap(null));
            waypointsMarkers = [];
        }

        // Add markers for waypoints
        function addWaypointMarker(location, text, videoSource) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            // Add click listener to show modal
            marker.addListener("click", () => {
                loadVideo(videoSource)
                //const modalText = document.getElementById("modalText");
                //modalText.innerText = text;
                // const modal = new bootstrap.Modal(document.getElementById("infoModal"));
                // modal.show();
            });

            waypointsMarkers.push(marker);
        }

        // ini dari kamera
        // function loadVideo(){
        //     // document.getElementById("videoSource").src = "/video_feed";
        //     // document.getElementById("trafficVideo").load();
        //     const videoElement = document.getElementById("trafficVideo");
        //     videoElement.src = "/video_feed"; // Set source ke endpoint Flask
        // }

        //ini dari streaming blob
        // function loadVideo() {
        //     const video = document.getElementById("trafficVideo");
        //     const videoSource = "https://extstream.hk-opt2.com/LiveApp/streams/710404214066673275657182.m3u8";

        //     if (video.canPlayType("application/vnd.apple.mpegurl")) {
        //         video.src = videoSource;
        //     } else if (Hls.isSupported()) {
        //         const hls = new Hls();
        //         hls.loadSource(videoSource);
        //         hls.attachMedia(video);
        //     } else {
        //         alert("Browser Anda tidak mendukung HLS.");
        //     }

        //     const modal = new bootstrap.Modal(document.getElementById("infoModal"));
        //     modal.show();
        // }

    //     function loadVideo(videoSource) {
    //     const video = document.getElementById("trafficVideo");

    //     // Set the video source dynamically
    //     const videoUrl = `/video_feed?video_url=${encodeURIComponent(videoSource)}`;

    //     if (video.canPlayType("application/vnd.apple.mpegurl")) {
    //         video.src = videoUrl;  // Direct stream from Flask endpoint
    //     } else if (Hls.isSupported()) {
    //         const hls = new Hls();
    //         hls.loadSource(videoUrl);
    //         hls.attachMedia(video);
    //     } else {
    //         alert("Browser Anda tidak mendukung HLS.");
    //     }

    //     // Show the modal
    //     const modal = new bootstrap.Modal(document.getElementById("infoModal"));
    //     modal.show();
    // }

    function loadVideo(videoSource) {
    const imageElement = document.getElementById("trafficImage");

    // Set src untuk video feed, akan otomatis menampilkan stream gambar
    imageElement.src = `/video_feed?video_url=${encodeURIComponent(videoSource)}`;

    // Menampilkan modal
    const modal = new bootstrap.Modal(document.getElementById("infoModal"));
    modal.show();
}


        document.getElementById("infoModal").addEventListener("hidden.bs.modal", () => {
            const video = document.getElementById("trafficVideo");

            // Hentikan video dan reset
            if (video) {
                video.pause();
                video.removeAttribute("src");
                video.load();
            }

            // Bersihkan backdrop jika tertinggal
            const backdrops = document.querySelectorAll(".modal-backdrop");
            backdrops.forEach(backdrop => backdrop.remove());

            // Pastikan scroll aktif kembali
            document.body.classList.remove("modal-open");
            document.body.style.overflow = "";
        });

        // Calculate the route
        async function calculateRoute() {
            const locationData = JSON.parse(document.getElementById("locationData").dataset.locations);
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            const avoidTraffic = document.getElementById("avoidTraffic").checked;

            if (start === end) {
                alert("Start Location dan End Location tidak boleh sama. Silakan pilih lokasi yang berbeda.");
                return; // Hentikan proses perhitungan rute
            }

            if (!start || !end) {
                alert("Please select both start and end locations.");
                return;
            }

            // Clear previous directions and markers
            directionsRenderer.setMap(null);
            directionsRenderer = new google.maps.DirectionsRenderer({ map });
            clearWaypointsMarkers();

            // Fetch route data from server
            const response = await fetch("/calculate_route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ start, end, avoid_traffic: avoidTraffic }),
            });

            if (!response.ok) {
                const error = await response.json();
                alert(error.error || "Failed to calculate route");
                return;
            }

            const routeData = await response.json();

            const request = {
                origin: new google.maps.LatLng(routeData.start.lat, routeData.start.lng),
                destination: new google.maps.LatLng(routeData.end.lat, routeData.end.lng),
                travelMode: google.maps.TravelMode.DRIVING,
                waypoints: routeData.waypoints.map(wp => ({
                    location: new google.maps.LatLng(wp.lat, wp.lng),
                    stopover: false,
                })),
            };

            // Display route on map
            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);

                    // Add markers for waypoints
                    routeData.waypoints.forEach(wp => {
                        addWaypointMarker({ lat: wp.lat, lng: wp.lng, }, "Waypoint", wp.videoSource);
                    });
                } else {
                    alert("Could not calculate route: " + status);
                }
            });
        }

    </script>
</body>

</html>