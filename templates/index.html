<!DOCTYPE html>
<html>

<head>
    <title>Route Planner - Avoid Traffic</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- API_KEY Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_0W5bZ8R4rsWwrFLlIxykVaWOrU6N4rQ&callback=initMap"
        defer></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }

        body {
            font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="locationData" data-locations='{{ locations | tojson | safe }}'></div>
    <div class="container mt-5">
        <h1 class="text-center">Route Planner - Avoid Traffic</h1>
        <form id="routeForm" class="row g-3 mt-4">
            <div class="col-md-6">
                <label for="start" class="form-label">Start Location:</label>
                <select id="start" name="start" class="form-select" required>
                    {% for key, loc in locations.items() %}
                    <option value="{{ key }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="end" class="form-label">End Location:</label>
                <select id="end" name="end" class="form-select" required>
                    {% for key, loc in locations.items() %}
                    <option value="{{ key }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="avoidTraffic" class="form-label">Avoid Traffic:</label>
                <input type="checkbox" id="avoidTraffic" class="form-check-input">
            </div>
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary" onclick="calculateRoute()">Find Route</button>
            </div>
        </form>
        <div id="map" class="mt-4"></div>
    </div>

    <!-- ini dari streaming blob -->

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Live Traffic Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">
                    <div class="d-flex">
                        <!-- Gambar video -->
                        <img id="trafficImage" src="" class="img-fluid" style="width: 70%; height: auto;" />
                
                        <!-- Container deteksi objek -->
                        <div id="objectCount" class="ms-3 p-2 d-flex flex-column justify-content-between"
                            style="width: 30%; overflow-y: auto; border-left: 1px solid #ddd; height: 100%;">
                            
                            <h5 class="text-center">Deteksi Objek</h5>
                
                            <!-- List objek -->
                            <ul id="objectList" class="flex-grow-1" style="list-style: none; padding: 0; margin: 0;"></ul>
                        </div>
                    </div>
                
                    <!-- Total objek di luar objectCount -->
                    <div id="totalObjects" class="text-center mt-2 p-2"
                        style="border-top: 2px solid #ddd; font-weight: bold; background-color: #f8f9fa;">
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        let map, directionsService, directionsRenderer, trafficLayer, waypointsMarkers = [];

        const locationData = { locations, toJson };

        // Initialize the map
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -7.915016, lng: 113.827289 }, // Default location
                zoom: 14,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
            });
        }

        // Clear existing markers
        function clearWaypointsMarkers() {
            waypointsMarkers.forEach(marker => marker.setMap(null));
            waypointsMarkers = [];
        }

        // Add markers for waypoints
        function addWaypointMarker(location, text, videoSource) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            // Add click listener to show modal
            marker.addListener("click", () => {
                loadVideo(videoSource)
            });

            waypointsMarkers.push(marker);
        }

        function loadVideo(videoSource) {
            const imageElement = document.getElementById("trafficImage");
            const objectCountElement = document.getElementById("objectCount");
            const totalObjectsElement = document.getElementById("totalObjects")

            // Set src untuk video feed
            imageElement.src = `/video_feed?video_url=${encodeURIComponent(videoSource)}`;

            // Menampilkan modal
            const modal = new bootstrap.Modal(document.getElementById("infoModal"));
            modal.show();

            // Update jumlah objek setiap 2 detik
            setInterval(async () => {
                const response = await fetch(`/object_count?video_url=${encodeURIComponent(videoSource)}`);
                const objectCounts = await response.json();

                // Tampilkan jumlah objek di modal
                if (!objectCounts.error) {
                    // menghitung total keseluruhan objek setiap kelas
                    const totalObjects = Object.values(objectCounts).reduce((sum, count) => sum + count, 0);

                    objectCountElement.innerHTML = Object.entries(objectCounts)
                        .map(([label, count]) => `<h6>${label}: ${count}</h6>`)
                        .join("");
                    totalObjectsElement.innerHTML = `<p>Total Kendaraan : ${totalObjects}</p>`
                } else {
                    objectCountElement.innerHTML = "<p>Tidak dapat mendeteksi objek</p>";
                }
            }, 2000);
        }

        document.getElementById("infoModal").addEventListener("hidden.bs.modal", () => {
            const video = document.getElementById("trafficImage");

            // Hentikan video dan reset
            if (video) {
                video.pause();
                video.removeAttribute("src");
                video.load();
            }

            // Bersihkan backdrop jika tertinggal
            const backdrops = document.querySelectorAll(".modal-backdrop");
            backdrops.forEach(backdrop => backdrop.remove());

            // Pastikan scroll aktif kembali
            document.body.classList.remove("modal-open");
            document.body.style.overflow = "";
        });

        // Calculate the route
        async function calculateRoute() {
            const locationData = JSON.parse(document.getElementById("locationData").dataset.locations);
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            const avoidTraffic = document.getElementById("avoidTraffic").checked;

            if (start === end) {
                alert("Start Location dan End Location tidak boleh sama. Silakan pilih lokasi yang berbeda.");
                return; // Hentikan proses perhitungan rute
            }

            if (!start || !end) {
                alert("Please select both start and end locations.");
                return;
            }

            // Clear previous directions and markers
            directionsRenderer.setMap(null);
            directionsRenderer = new google.maps.DirectionsRenderer({ map });
            clearWaypointsMarkers();

            // Fetch route data from server
            const response = await fetch("/calculate_route", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ start, end, avoid_traffic: avoidTraffic }),
            });

            if (!response.ok) {
                const error = await response.json();
                alert(error.error || "Failed to calculate route");
                return;
            }

            const routeData = await response.json();

            const request = {
                origin: new google.maps.LatLng(routeData.start.lat, routeData.start.lng),
                destination: new google.maps.LatLng(routeData.end.lat, routeData.end.lng),
                travelMode: google.maps.TravelMode.DRIVING,
                waypoints: routeData.waypoints.map(wp => ({
                    location: new google.maps.LatLng(wp.lat, wp.lng),
                    stopover: false,
                })),
            };

            // Display route on map
            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);

                    // Add markers for waypoints
                    routeData.point_marker.forEach(wp => {
                        addWaypointMarker({ lat: wp.lat, lng: wp.lng, }, "Waypoint", wp.videoSource);
                    });
                } else {
                    alert("Could not calculate route: " + status);
                }
            });
        }

    </script>
</body>

</html>